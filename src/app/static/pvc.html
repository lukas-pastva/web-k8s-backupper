<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PVC Browser ¬∑ web-k8s-backupper</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/theme.js" defer></script>
    <style>
      .tree{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
      .tree ul{list-style:none;margin:0;padding-left:18px}
      .tree .node{display:flex;align-items:center;gap:8px;line-height:1.4}
      .tree .node .icon{width:1.2em;text-align:center}
      .tree summary{cursor:pointer}
      .meta{color:var(--muted);font-size:12px}
      .toolbar{display:flex;gap:8px;align-items:center;margin-left:auto}
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <h1 id="title">PVC Browser</h1>
        <nav class="breadcrumbs"><a href="/">üó∫Ô∏è Namespaces</a> <span class="sep">‚Ä∫</span> <a id="crumb-ns" href="#">üß≠ </a> <span class="sep">‚Ä∫</span> <span id="crumb-pvc" class="current">üíæ </span></nav>
      </div>
      <div class="actions header-right">
        <a id="refresh" href="#" class="button" title="Refresh">üîÑ Refresh</a>
        <a id="help-btn" href="#" class="button" title="How to use" aria-label="Help">‚ÑπÔ∏è</a>
        <a href="#" class="button" data-role="theme-toggle" title="Theme">üåì Theme</a>
      </div>
    </header>
    <main>
      <section>
        <div id="info" class="meta"></div>
        <div id="tree" class="tree"><div class="hint">Loading‚Ä¶</div></div>
      </section>
    </main>
    <script>
      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      const ns = getParam('ns');
      const pvc = getParam('pvc');
      document.getElementById('title').textContent = ns && pvc ? `üíæ ${ns}/${pvc}` : 'üíæ PVC Browser';

      document.getElementById('refresh').addEventListener('click', (e) => {
        e.preventDefault(); loadTree();
      });

      // Back button (right toolbar)
      const crumbNs = document.getElementById('crumb-ns');
      const crumbPvc = document.getElementById('crumb-pvc');
      if (ns && crumbNs) {
        crumbNs.href = `/namespace?ns=${encodeURIComponent(ns)}`;
        crumbNs.textContent = `üß≠ ${ns}`;
      }
      if (pvc && crumbPvc) {
        crumbPvc.textContent = `üíæ ${pvc}`;
      }

      function esc(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

      function zipHref(path){
        return `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/zip?path=${encodeURIComponent(path)}`;
      }

      function dbDumpHref(){
        return `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/db/dump?format=zip`;
      }

      function nodeDirTemplate(label, path){
        return `
          <details>
            <summary class="node"><span class="icon">üìÅ</span><span>${label}</span>
              <span style="margin-left:auto"></span>
              <a class="button sm" href="${zipHref(path)}" onclick="event.stopPropagation()">üóúÔ∏è ZIP</a>
            </summary>
            <ul><li class="node meta">Loading‚Ä¶</li></ul>
          </details>
        `;
      }

      function nodeFileTemplate(label, fullPath, size, mtime){
        const href = `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/file?path=${encodeURIComponent(fullPath)}`;
        const prev = `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/preview?path=${encodeURIComponent(fullPath)}`;
        const meta = renderMeta(size, mtime);
        return `<li class="node"><span class="icon">üìÑ</span><span>${label}</span> ${meta}
          <span style="margin-left:auto"></span>
          <a class="button sm" href="${prev}" target="_blank">üëÅÔ∏è Preview</a>
          <a class="button sm" href="${href}">‚¨áÔ∏è Download</a>
        </li>`;
      }

      async function fetchList(path){
        const url = `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/ls?path=${encodeURIComponent(path)}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      function humanSize(n){
        const units=['B','KB','MB','GB','TB'];
        let i=0, v=Number(n)||0; while(v>=1024 && i<units.length-1){ v/=1024; i++; }
        return `${v.toFixed(v<10&&i>0?1:0)} ${units[i]}`;
      }

      function renderMeta(size, mtime){
        const parts=[]; if(Number.isFinite(size)) parts.push(humanSize(size));
        if(Number.isFinite(mtime) && mtime>0){ parts.push(new Date(mtime*1000).toLocaleString()); }
        return parts.length?`<span class="meta">(${parts.join(' ¬∑ ')})</span>`:'';
      }

      async function populateDir(container, path){
        // container is the <ul> element inside details
        try{
          const data = await fetchList(path);
          const items = data.entries || [];
          if(items.length === 0){
            container.innerHTML = '<li class="node meta">(empty)</li>';
            return;
          }
          container.innerHTML = '';
          for(const it of items){
            const label = esc(it.name);
            const fullPath = path === '.' ? it.name : `${path}/${it.name}`;
            if(it.type === 'dir'){
              const wrapper = document.createElement('li');
              wrapper.innerHTML = nodeDirTemplate(label, fullPath);
              const details = wrapper.querySelector('details');
              const ul = wrapper.querySelector('ul');
              details.addEventListener('toggle', () => {
                if(details.open && !details.dataset.loaded){
                  details.dataset.loaded = '1';
                  populateDir(ul, fullPath).catch(e => { ul.innerHTML = `<li class=\"node error\">${esc(String(e))}</li>`; });
                }
              }, { once: true });
              container.appendChild(wrapper);
            } else {
              const li = document.createElement('li');
              li.innerHTML = nodeFileTemplate(label, fullPath, it.size, it.mtime);
              container.appendChild(li);
            }
          }
        } catch(e){
          container.innerHTML = `<li class="node error">Failed: ${esc(String(e))}</li>`;
        }
      }

      async function init(){
        const el = document.getElementById('tree');
        el.innerHTML = nodeDirTemplate('/', '.');
        const rootDetails = el.querySelector('details');
        rootDetails.setAttribute('open','');
        const rootUl = el.querySelector('ul');
        await populateDir(rootUl, '.');
      }

      async function loadDbInfo(){
        if(!ns || !pvc) return;
        const infoEl = document.getElementById('info');
        try {
          const res = await fetch(`/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/db/detect`);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if(data && data.isDatabase){
            const eng = data.engine || 'db';
            infoEl.innerHTML = `Detected database: <code>${eng}</code> in <code>${data.pod || ''}/${data.container || ''}</code>`;
            const refresh = document.getElementById('refresh');
            const a = document.createElement('a');
            a.className = 'button';
            a.textContent = `üóÑÔ∏è DB Dump (${eng})`;
            a.href = dbDumpHref();
            if (refresh && refresh.parentElement) {
              refresh.insertAdjacentElement('afterend', a);
            }
          } else {
            infoEl.textContent = 'No database detected for this PVC.';
          }
        } catch (e) {
          // Non-fatal
        }
      }

      init();
      loadDbInfo();

      // Help modal
      function createHelpModal(){
        const m = document.createElement('div');
        m.id = 'help-modal';
        m.className = 'modal';
        m.setAttribute('role','dialog');
        m.setAttribute('aria-modal','true');
        m.hidden = true;
        m.innerHTML = `
          <div class="box">
            <div class="modal-header">
              <div class="title">‚ÑπÔ∏è Help</div>
              <div class="toolbar">
                <button class="button sm" id="close-help" title="Close">‚úñ Close</button>
              </div>
            </div>
            <div class="content content-text">
              <ul>
                <li>Click folders to expand and load contents on demand.</li>
                <li>Use <strong>ZIP</strong> on any folder to download a compressed archive.</li>
                <li>Use <strong>Preview</strong> to open files supported by the server.</li>
                <li>Use the header <strong>Refresh</strong> to reload the root listing.</li>
                <li>If a database is detected, a <strong>DB Dump</strong> button appears near Refresh.</li>
              </ul>
            </div>
          </div>`;
        document.body.appendChild(m);
        m.addEventListener('click', (e) => { if(e.target === m) hideHelp(); });
        m.querySelector('#close-help').addEventListener('click', hideHelp);
        return m;
      }
      const helpModal = createHelpModal();
      function showHelp(){ helpModal.hidden = false; }
      function hideHelp(){ helpModal.hidden = true; }
      document.getElementById('help-btn')?.addEventListener('click', (e) => { e.preventDefault(); showHelp(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !helpModal.hidden) hideHelp(); });
    </script>
  </body>
  </html>
