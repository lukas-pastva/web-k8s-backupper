<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PVC Browser ¬∑ web-k8s-backupper</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/theme.js" defer></script>
    <style>
      .tree{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
      .tree ul{list-style:none;margin:0;padding-left:18px}
      .tree .node{display:flex;align-items:center;gap:8px;line-height:1.4}
      .tree .node .icon{width:1.2em;text-align:center}
      .tree summary{cursor:pointer}
      .meta{color:var(--muted);font-size:12px}
      .toolbar{display:flex;gap:8px;align-items:center;margin-left:auto}
    </style>
  </head>
  <body>
    <header>
      <a class="back" href="/">‚Üê All namespaces</a>
      <h1 id="title">PVC Browser</h1>
      <div class="toolbar">
        <a href="#" class="button" data-role="theme-toggle" title="Theme">üåì</a>
        <a id="refresh" href="#" class="button">Refresh</a>
      </div>
    </header>
    <main>
      <section>
        <div id="info" class="meta"></div>
        <div id="tree" class="tree"><div class="hint">Loading‚Ä¶</div></div>
      </section>
    </main>
    <script>
      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      const ns = getParam('ns');
      const pvc = getParam('pvc');
      document.getElementById('title').textContent = ns && pvc ? `${ns}/${pvc}` : 'PVC Browser';

      document.getElementById('refresh').addEventListener('click', (e) => {
        e.preventDefault(); loadTree();
      });

      function esc(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

      function nodeDirTemplate(label){
        return `
          <details>
            <summary class="node"><span class="icon">üìÅ</span><span>${label}</span></summary>
            <ul><li class="node meta">Loading‚Ä¶</li></ul>
          </details>
        `;
      }

      function nodeFileTemplate(label, fullPath){
        const href = `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/file?path=${encodeURIComponent(fullPath)}`;
        return `<li class="node"><span class="icon">üìÑ</span><span>${label}</span> <a class="button" style="padding:2px 6px" href="${href}">Download</a></li>`;
      }

      async function fetchList(path){
        const url = `/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc)}/ls?path=${encodeURIComponent(path)}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      async function populateDir(container, path){
        // container is the <ul> element inside details
        try{
          const data = await fetchList(path);
          const items = data.entries || [];
          if(items.length === 0){
            container.innerHTML = '<li class="node meta">(empty)</li>';
            return;
          }
          container.innerHTML = '';
          for(const it of items){
            const label = esc(it.name);
            const fullPath = path === '.' ? it.name : `${path}/${it.name}`;
            if(it.type === 'dir'){
              const wrapper = document.createElement('li');
              wrapper.innerHTML = nodeDirTemplate(label);
              const details = wrapper.querySelector('details');
              const ul = wrapper.querySelector('ul');
              details.addEventListener('toggle', () => {
                if(details.open && !details.dataset.loaded){
                  details.dataset.loaded = '1';
                  populateDir(ul, fullPath).catch(e => { ul.innerHTML = `<li class=\"node error\">${esc(String(e))}</li>`; });
                }
              }, { once: true });
              container.appendChild(wrapper);
            } else {
              const li = document.createElement('li');
              li.innerHTML = nodeFileTemplate(label, fullPath);
              container.appendChild(li);
            }
          }
        } catch(e){
          container.innerHTML = `<li class="node error">Failed: ${esc(String(e))}</li>`;
        }
      }

      async function init(){
        const el = document.getElementById('tree');
        el.innerHTML = nodeDirTemplate('/');
        const rootDetails = el.querySelector('details');
        rootDetails.setAttribute('open','');
        const rootUl = el.querySelector('ul');
        await populateDir(rootUl, '.');
      }

      init();
    </script>
  </body>
  </html>
