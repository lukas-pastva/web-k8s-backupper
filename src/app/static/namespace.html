<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Namespace · web-k8s-backupper</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/theme.js" defer></script>
  </head>
  <body>
    <header>
      <a class="back" href="/">← All namespaces</a>
      <h1 id="ns-title"></h1>
      <div class="actions">
        <a href="#" class="button" data-role="theme-toggle">Theme</a>
        <label><input type="checkbox" id="includeSecrets" /> Include Secrets</label>
        <a id="view-manifests" class="button" href="#" target="_blank">View Manifests</a>
        <a id="dl-manifests" class="button" href="#">Download Manifests</a>
      </div>
    </header>
    <main>
      <section>
        <h2>PersistentVolumeClaims</h2>
        <div id="pvcs" class="cards"></div>
      </section>
      <section>
        <h2>Objects</h2>
        <div id="objects" class="grid"></div>
      </section>
    </main>
    <script>
      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      const ns = getParam('ns');
      document.getElementById('ns-title').textContent = ns ? `Namespace: ${ns}` : 'Namespace';

      const includeSecrets = document.getElementById('includeSecrets');
      const dl = document.getElementById('dl-manifests');
      const view = document.getElementById('view-manifests');
      function updateManifestLinks() {
        const inc = includeSecrets.checked ? 'true' : 'false';
        view.href = `/api/namespaces/${encodeURIComponent(ns)}/manifests?includeSecrets=${inc}&download=false`;
        dl.href = `/api/namespaces/${encodeURIComponent(ns)}/manifests?includeSecrets=${inc}&download=true`;
      }
      includeSecrets.addEventListener('change', updateManifestLinks);
      updateManifestLinks();

      async function loadPVCs() {
        const el = document.getElementById('pvcs');
        el.innerHTML = '<div class="hint">Loading PVCs…</div>';
        try {
          const res = await fetch(`/api/namespaces/${encodeURIComponent(ns)}/pvcs`);
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            el.innerHTML = '<div class="hint">No PVCs found.</div>';
            return;
          }
          el.innerHTML = data.map(pvc => `
            <div class="card">
              <div class="title">${pvc.name}</div>
              <div class="desc">SC: ${pvc.storageClass || '-'} · Capacity: ${pvc.capacity || '-'} · Modes: ${(pvc.accessModes||[]).join(', ')}</div>
              <a class="button" href="/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc.name)}/download">Download PVC</a>
              <a class="button" href="/pvc?ns=${encodeURIComponent(ns)}&pvc=${encodeURIComponent(pvc.name)}">Browse</a>
            </div>
          `).join('');
        } catch (e) {
          el.innerHTML = `<div class="error">Failed to load PVCs: ${e}</div>`;
        }
      }

      async function loadObjects() {
        const el = document.getElementById('objects');
        el.innerHTML = '<div class="hint">Loading objects…</div>';
        try {
          const res = await fetch(`/api/namespaces/${encodeURIComponent(ns)}/objects`);
          const data = await res.json();
          const kinds = Object.keys(data).sort();
          if (kinds.length === 0) {
            el.innerHTML = '<div class="hint">No objects found.</div>';
            return;
          }
          el.innerHTML = kinds.map(k => `
            <div class="panel">
              <div class="panel-title">${k}</div>
              <div class="panel-body panel-list">${(data[k]||[]).map(n => `
                <a class="obj-item" target="_blank" href="/api/namespaces/${encodeURIComponent(ns)}/objects/${encodeURIComponent(k)}/${encodeURIComponent(n)}/manifest?download=false">${n}</a>
              `).join('')}</div>
            </div>
          `).join('');
        } catch (e) {
          el.innerHTML = `<div class="error">Failed to load objects: ${e}</div>`;
        }
      }

      loadPVCs();
      loadObjects();
    </script>
  </body>
  </html>
