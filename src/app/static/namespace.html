<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Namespace · web-k8s-backupper</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/theme.js" defer></script>
  </head>
  <body>
    <header>
      <nav class="breadcrumbs"><a href="/">🗺️ Namespaces</a> <span class="sep">›</span> <span id="crumb-ns" class="current"></span></nav>
      <h1 id="ns-title"></h1>
      <a id="view-manifests" class="button" href="#" target="_blank">📄 View Manifests</a>
      <a id="dl-manifests" class="button" href="#">⬇️ Download Manifests</a>
      <div class="actions">
        <a href="#" class="button" data-role="theme-toggle">🌓 Theme</a>
      </div>
    </header>
    <main>
      <section>
        <h2>💾 PersistentVolumeClaims</h2>
        <div id="pvcs" class="cards"></div>
      </section>
      <section>
        <h2>🗂️ Objects</h2>
        <div class="filter-row" style="margin: 8px 0 14px; display:flex; gap:8px; align-items:center;">
          <label for="obj-filter" class="hint" style="min-width:max(80px,12ch)">Filter:</label>
          <input id="obj-filter" type="search" placeholder="Type to filter objects…" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text)" autocomplete="off" />
        </div>
        <div id="objects" class="grid"></div>
      </section>
    </main>
    <script>
      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      const ns = getParam('ns');
      document.getElementById('ns-title').textContent = ns ? `🧭 Namespace: ${ns}` : '🧭 Namespace';
      const crumbNs = document.getElementById('crumb-ns');
      if (crumbNs) crumbNs.textContent = ns || '';

      const dl = document.getElementById('dl-manifests');
      const view = document.getElementById('view-manifests');
      function updateManifestLinks() {
        const base = `/api/namespaces/${encodeURIComponent(ns)}/manifests`;
        const qsView = new URLSearchParams({ includeSecrets: 'true', revealSecrets: 'true', download: 'false' });
        const qsDl = new URLSearchParams({ includeSecrets: 'true', revealSecrets: 'true', download: 'true' });
        view.href = `${base}?${qsView.toString()}`;
        dl.href = `${base}?${qsDl.toString()}`;
      }
      updateManifestLinks();

  function iconForKind(kind){
    const k = String(kind || '').toLowerCase();
    if(k === 'pods') return '📦';
    if(k === 'services') return '🌐';
    if(k === 'configmaps') return '🧩';
    if(k === 'secrets') return '🔑';
    if(k === 'persistentvolumeclaims') return '💾';
    if(k === 'deployments') return '🚀';
    if(k === 'statefulsets') return '🧱';
    if(k === 'daemonsets') return '🛡️';
    if(k === 'jobs') return '🕒';
    if(k === 'cronjobs') return '⏰';
    if(k === 'ingresses') return '🧭';
    if(k === 'roles') return '👤';
    if(k === 'rolebindings') return '🤝';
    return '📄';
  }

      async function loadPVCs() {
        const el = document.getElementById('pvcs');
        el.innerHTML = '<div class="hint">Loading PVCs…</div>';
        try {
          const res = await fetch(`/api/namespaces/${encodeURIComponent(ns)}/pvcs`);
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            el.innerHTML = '<div class="hint">No PVCs found.</div>';
            return;
          }
          el.innerHTML = data.map(pvc => `
            <div class="card">
              <div class="title">${pvc.name}</div>
              <div class="desc">SC: ${pvc.storageClass || '-'} · Capacity: ${pvc.capacity || '-'} · Modes: ${(pvc.accessModes||[]).join(', ')}</div>
              <a class="button" href="/api/namespaces/${encodeURIComponent(ns)}/pvcs/${encodeURIComponent(pvc.name)}/download">🗜️ ZIP PVC</a>
              <a class="button" href="/pvc?ns=${encodeURIComponent(ns)}&pvc=${encodeURIComponent(pvc.name)}">📂 Browse</a>
            </div>
          `).join('');
        } catch (e) {
          el.innerHTML = `<div class="error">Failed to load PVCs: ${e}</div>`;
        }
      }

      const objectsEl = document.getElementById('objects');
      const objFilterEl = document.getElementById('obj-filter');
      let ALL_OBJECTS = {};

      function renderObjects(){
        const q = (objFilterEl?.value || '').trim().toLowerCase();
        const kinds = Object.keys(ALL_OBJECTS || {}).sort();
        const total = kinds.reduce((acc,k)=>acc + ((ALL_OBJECTS[k]||[]).length), 0);
        const panels = [];
        for(const k of kinds){
          const names = (ALL_OBJECTS[k]||[]);
          const filtered = q ? names.filter(n => n.toLowerCase().includes(q)) : names;
          if(filtered.length === 0) continue; // skip empty kinds entirely
          panels.push(`
            <div class="panel">
              <div class="panel-title">${iconForKind(k)} ${k}</div>
              <div class="panel-body panel-list">${filtered.map(n => `
                <a class="obj-item" href="#" data-kind="${k}" data-name="${n}">${iconForKind(k)} ${n}</a>
              `).join('')}</div>
            </div>
          `);
        }
        if(panels.length === 0){
          objectsEl.innerHTML = q && total > 0 ? '<div class="hint">No objects match your filter.</div>' : '<div class="hint">No objects found.</div>';
        } else {
          objectsEl.innerHTML = panels.join('');
        }
      }

      async function loadObjects() {
        objectsEl.innerHTML = '<div class="hint">Loading objects…</div>';
        try {
          const res = await fetch(`/api/namespaces/${encodeURIComponent(ns)}/objects`);
          const data = await res.json();
          ALL_OBJECTS = data || {};
          renderObjects();
        } catch (e) {
          objectsEl.innerHTML = `<div class="error">Failed to load objects: ${e}</div>`;
        }
      }

      // Modal for manifest preview
      function createModal(){
        const modal = document.createElement('div');
        modal.id = 'manifest-modal';
        modal.className = 'modal';
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        modal.hidden = true;
        modal.innerHTML = `
          <div class="box">
            <div class="modal-header">
              <div class="title">Manifest: <span id="manifest-title"></span></div>
              <div class="toolbar">
                <button class="button sm" id="copy-manifest" title="Copy to clipboard">📋 Copy</button>
                <button class="button sm" id="close-manifest" title="Close (Esc)">✖ Close</button>
              </div>
            </div>
            <pre class="content" id="manifest-content"></pre>
          </div>`;
        document.body.appendChild(modal);
        // Close on background click
        modal.addEventListener('click', (e) => { if(e.target === modal) hideModal(); });
        modal.querySelector('#close-manifest').addEventListener('click', hideModal);
        modal.querySelector('#copy-manifest').addEventListener('click', () => {
          const txt = document.getElementById('manifest-content').textContent;
          navigator.clipboard.writeText(txt).catch(() => {});
        });
        return modal;
      }
      const modal = createModal();
      function showModal(title, text){
        document.getElementById('manifest-title').textContent = title;
        document.getElementById('manifest-content').textContent = text;
        modal.hidden = false;
      }
      function hideModal(){ modal.hidden = true; }

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.hidden) {
          hideModal();
        }
      });

      // Open object manifest in a popup instead of new tab
      document.getElementById('objects').addEventListener('click', async (e) => {
        const a = e.target.closest('.obj-item');
        if(!a) return;
        e.preventDefault();
        const kind = a.dataset.kind;
        const name = a.dataset.name;
        const url = `/api/namespaces/${encodeURIComponent(ns)}/objects/${encodeURIComponent(kind)}/${encodeURIComponent(name)}/manifest?download=false${kind==='secrets'?'&revealSecrets=true':''}`;
        try{
          const res = await fetch(url);
          const text = await res.text();
          if(!res.ok){
            showModal(`${kind}/${name}`, `HTTP ${res.status}\n\n${text}`);
          } else {
            showModal(`${kind}/${name}`, text);
          }
        }catch(err){
          showModal(`${kind}/${name}`, `Failed to load manifest: ${err}`);
        }
      });

      loadPVCs();
      loadObjects();
      if (objFilterEl) objFilterEl.addEventListener('input', renderObjects);
    </script>
  </body>
  </html>
